{"id":"cmux15-08d","title":"Implement Bitbucket provider adapter","description":"Implement Bitbucket support using the GitProvider abstraction.\n\n## Files to Create\n- packages/shared/src/git-providers/bitbucket/index.ts\n- packages/shared/src/git-providers/bitbucket/types.ts\n\n## Implementation\n- Use Bitbucket Cloud REST API 2.0\n- Implement GitProvider interface\n- Map Bitbucket concepts to normalized types:\n  - Pull Request → PullRequest (same name)\n  - Repository → Repository\n  - Comments → Comments\n\n## Bitbucket-Specific Considerations\n- Bitbucket Apps (OAuth consumers)\n- Workspace vs Repository permissions\n- Bitbucket Pipelines integration\n- Self-hosted Bitbucket Server/Data Center (different API)\n\n## API Client\n- Custom fetch-based client\n- OAuth 2.0 with refresh tokens","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T22:55:33.788951-08:00","updated_at":"2025-12-02T22:55:33.788951-08:00","dependencies":[{"issue_id":"cmux15-08d","depends_on_id":"cmux15-t6p","type":"blocks","created_at":"2025-12-02T22:55:40.195772-08:00","created_by":"daemon"}]}
{"id":"cmux15-0bz","title":"Create VM provider factory and registry","description":"Implement factory pattern for instantiating VM providers.\n\n## Implementation\n```typescript\n// packages/shared/src/vm-providers/registry.ts\n\ntype VMProviderName = 'morph' | 'daytona' | 'fly' | 'railway' | 'docker'\n\ninterface VMProviderRegistry {\n  register(name: VMProviderName, factory: () =\u003e VMProvider): void\n  get(name: VMProviderName): VMProvider\n  getDefault(): VMProvider\n  list(): VMProviderName[]\n}\n\nconst registry: VMProviderRegistry = {\n  providers: new Map(),\n  defaultProvider: 'morph',\n  \n  register(name, factory) {\n    this.providers.set(name, factory)\n  },\n  \n  get(name) {\n    const factory = this.providers.get(name)\n    if (\\!factory) throw new Error(`Unknown VM provider: ${name}`)\n    return factory()\n  },\n  \n  getDefault() {\n    return this.get(this.defaultProvider)\n  }\n}\n\n// Initialize with available providers\nregistry.register('morph', () =\u003e new MorphCloudProvider({\n  apiKey: env.MORPH_API_KEY\n}))\n\nregistry.register('daytona', () =\u003e new DaytonaProvider({\n  serverUrl: env.DAYTONA_SERVER_URL\n}))\n\nexport { registry as vmProviderRegistry }\n```\n\n## Usage\n```typescript\n// In sandboxes.route.ts\nconst provider = vmProviderRegistry.get(requestedProvider || 'morph')\nconst instance = await provider.startInstance({...})\n```\n\n## Files to Create\n- packages/shared/src/vm-providers/registry.ts\n- packages/shared/src/vm-providers/config.ts\n\n## Environment Variables\n```\n# Current\nMORPH_API_KEY=\n\n# New for Daytona\nDAYTONA_SERVER_URL=\nDAYTONA_API_KEY=\n\n# Future providers\nFLY_API_TOKEN=\nRAILWAY_API_TOKEN=\n```","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:50:58.299789-08:00","updated_at":"2025-12-02T23:50:58.299789-08:00","dependencies":[{"issue_id":"cmux15-0bz","depends_on_id":"cmux15-dvj","type":"blocks","created_at":"2025-12-02T23:51:04.456121-08:00","created_by":"daemon"},{"issue_id":"cmux15-0bz","depends_on_id":"cmux15-fq3","type":"blocks","created_at":"2025-12-02T23:51:04.504087-08:00","created_by":"daemon"}]}
{"id":"cmux15-0me","title":"Abstract snapshot/image management for VM providers","description":"Abstract the snapshot/base image concept across providers.\n\n## Current State\nMorphCloud uses snapshots:\n- packages/shared/src/morph-snapshots.ts - Snapshot manifest with versions\n- packages/shared/src/morph-snapshots.json - 12 versions × 3 presets\n- apps/www/lib/utils/morph-defaults.ts - Default snapshot ID\n- apps/www/lib/routes/sandboxes/snapshot.ts - Snapshot resolution\n\n## Provider Image Concepts\n| Provider | Base Image Concept |\n|----------|-------------------|\n| MorphCloud | Snapshots (snapshot_xxx) |\n| Daytona | Workspace templates / Git repos |\n| Docker | Docker images |\n| Fly.io | Docker images / Machines |\n| Railway | Docker images / Templates |\n\n## Abstraction Design\n```typescript\ninterface VMImage {\n  id: string\n  provider: VMProviderName\n  name: string\n  description?: string\n  version?: string\n  resources?: {\n    vcpu: number\n    memoryMb: number\n    diskGb: number\n  }\n  metadata?: Record\u003cstring, unknown\u003e\n  createdAt?: number\n}\n\ninterface VMImageRegistry {\n  // List available images for a provider\n  listImages(provider: VMProviderName): Promise\u003cVMImage[]\u003e\n  \n  // Get default image for a provider\n  getDefaultImage(provider: VMProviderName): Promise\u003cVMImage\u003e\n  \n  // Resolve environment to image\n  resolveEnvironmentImage(environmentId: string): Promise\u003cVMImage\u003e\n}\n```\n\n## Migration\n- Keep morph-snapshots.ts for Morph-specific presets\n- Abstract selection logic to work with any provider\n- Environment table already has `morphSnapshotId` → generalize to `imageId` + `provider`\n\n## Files to Modify\n- packages/shared/src/morph-snapshots.ts → keep but use via abstraction\n- apps/www/lib/routes/sandboxes/snapshot.ts → generalize\n- packages/convex/convex/environments.ts → add provider field\n\n## Schema Changes\n```typescript\n// environments table\n{\n  // Existing\n  morphSnapshotId: string,\n  \n  // New (with migration)\n  vmProvider: 'morph' | 'daytona' | ...,\n  vmImageId: string,  // Provider-specific image ID\n}\n```","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:51:44.910085-08:00","updated_at":"2025-12-02T23:51:44.910085-08:00","dependencies":[{"issue_id":"cmux15-0me","depends_on_id":"cmux15-6jg","type":"blocks","created_at":"2025-12-02T23:51:50.840869-08:00","created_by":"daemon"}]}
{"id":"cmux15-1yl","title":"Update code review system for multi-provider support","description":"Update AI code review system to work with GitLab and Bitbucket.\n\n## Current State\n- apps/www/lib/services/code-review/ - Code review services\n- apps/www/lib/routes/github.prs.code.route.ts - Code review endpoint\n- Uses GitHub API to fetch PR diff and files\n- Posts review comments to GitHub PRs\n\n## Components to Abstract\n\n### 1. Diff Fetching\n- Get PR/MR diff content\n- Get changed files list\n- Already covered by cmux15-xha (file content retrieval)\n\n### 2. Review Comment Posting\n```typescript\ninterface CodeReviewProvider {\n  // Create review with comments\n  createReview(repo: string, prNumber: number, review: ReviewInput): Promise\u003cReview\u003e\n  \n  // Single comment on specific line\n  createLineComment(repo: string, prNumber: number, comment: LineComment): Promise\u003cComment\u003e\n  \n  // Reply to existing comment\n  replyToComment(repo: string, commentId: string, body: string): Promise\u003cComment\u003e\n  \n  // List existing reviews/comments\n  listReviews(repo: string, prNumber: number): Promise\u003cReview[]\u003e\n}\n```\n\n## Provider Differences\n| Feature | GitHub | GitLab | Bitbucket |\n|---------|--------|--------|-----------|\n| Reviews | Pull Request Reviews | MR Approvals | PR Approvals |\n| Line comments | Review comments | Discussion notes | Inline comments |\n| Suggestions | Suggestion blocks | Suggestion syntax | Not supported |\n| Approval status | APPROVE/REQUEST_CHANGES | approve/unapprove | approve |\n\n## Files to Modify\n- apps/www/lib/services/code-review/*.ts\n- apps/www/lib/routes/github.prs.code.route.ts\n\n## Considerations\n- Review UX may differ by provider\n- Suggestion syntax varies\n- Approval workflows differ","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:13:59.215428-08:00","updated_at":"2025-12-02T23:13:59.215428-08:00","dependencies":[{"issue_id":"cmux15-1yl","depends_on_id":"cmux15-xha","type":"blocks","created_at":"2025-12-02T23:14:05.551574-08:00","created_by":"daemon"},{"issue_id":"cmux15-1yl","depends_on_id":"cmux15-jiw","type":"blocks","created_at":"2025-12-02T23:14:05.590776-08:00","created_by":"daemon"}]}
{"id":"cmux15-282","title":"Add integration tests for git providers","description":"Create comprehensive tests for the git provider abstraction.\n\n## Test Categories\n\n### Unit Tests\n- Provider interface implementation tests\n- Webhook payload normalization tests\n- Auth token generation tests\n\n### Integration Tests\n- GitHub API mock tests\n- GitLab API mock tests  \n- Bitbucket API mock tests\n\n### E2E Tests\n- OAuth flow tests (per provider)\n- Webhook delivery tests\n- PR operations tests\n\n## Test Files to Create\n- packages/shared/src/git-providers/__tests__/github.test.ts\n- packages/shared/src/git-providers/__tests__/gitlab.test.ts\n- packages/shared/src/git-providers/__tests__/bitbucket.test.ts\n- packages/shared/src/git-providers/__tests__/webhook-normalization.test.ts\n- packages/convex/convex/__tests__/webhook.test.ts\n\n## Test Data\n- Sample webhook payloads for each provider\n- Mock API responses\n- Test fixtures for normalized types\n\n## Considerations\n- Use vitest per project conventions\n- No mocking per project rules - use real API calls where possible\n- Test files next to implementation files","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T22:58:03.044863-08:00","updated_at":"2025-12-02T22:58:03.044863-08:00","dependencies":[{"issue_id":"cmux15-282","depends_on_id":"cmux15-lv3","type":"blocks","created_at":"2025-12-02T22:58:08.475058-08:00","created_by":"daemon"}]}
{"id":"cmux15-2i4","title":"Add Bitbucket App setup and OAuth flow","description":"Create Bitbucket OAuth Consumer and implement integration.\n\n## Bitbucket App Setup\n1. Create OAuth consumer at bitbucket.org/[workspace]/workspace/settings/oauth-consumers\n2. Configure permissions: repository, pullrequest, webhook\n3. Set callback URL to /auth/callback/bitbucket\n\n## Implementation\n\n### OAuth Routes\n- GET /auth/bitbucket/authorize - Redirect to Bitbucket OAuth\n- GET /auth/callback/bitbucket - Handle OAuth callback\n\n### Stack Auth Integration\n- Add Bitbucket as OAuth provider in Stack Auth config\n- Store Bitbucket OAuth tokens with refresh token handling\n\n### Environment Variables\n```\nCMUX_BITBUCKET_APP_KEY=\nCMUX_BITBUCKET_APP_SECRET=\nBITBUCKET_WEBHOOK_SECRET=\n```\n\n### Files to Create\n- apps/www/lib/routes/bitbucket.oauth.route.ts\n- apps/www/lib/routes/bitbucket.setup.route.ts\n\n### Considerations\n- Workspace-level vs Repository-level access\n- Bitbucket Cloud vs Bitbucket Server (Data Center)\n- Token refresh flow (Bitbucket tokens expire)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T22:57:30.907592-08:00","updated_at":"2025-12-02T22:57:30.907592-08:00","dependencies":[{"issue_id":"cmux15-2i4","depends_on_id":"cmux15-08d","type":"blocks","created_at":"2025-12-02T22:57:35.487238-08:00","created_by":"daemon"}]}
{"id":"cmux15-2vu","title":"Design VM provider abstraction architecture","description":"Define the core interfaces and architecture for abstracting VM/sandbox providers (MorphCloud, Daytona, etc.).\n\n## Current State\n- MorphCloud is the primary VM provider\n- Partial abstraction exists: `provider: 'docker' | 'morph' | 'daytona' | 'other'`\n- `VSCodeInstance` abstract class with `CmuxVSCodeInstance` (Morph) implementation\n- `sandboxes.route.ts` directly uses `MorphCloudClient`\n\n## Key Decisions Needed\n1. **Interface Design**\n   - What operations must all VM providers support?\n   - How to handle provider-specific features (snapshots, wake-on, etc.)?\n   \n2. **Snapshot Strategy**\n   - MorphCloud uses snapshots for fast boot\n   - Other providers may use Docker images, AMIs, etc.\n   - How to abstract 'base image' concept?\n\n3. **Networking Model**\n   - MorphCloud exposes ports via httpServices\n   - Daytona uses different model\n   - How to abstract service discovery?\n\n4. **Instance Lifecycle**\n   - start, stop, pause, resume (Morph-specific?)\n   - TTL and auto-cleanup\n   - Wake-on-demand\n\n5. **Command Execution**\n   - instance.exec() for setup commands\n   - Git configuration, env var injection\n   - Script execution\n\n## Deliverables\n- Core TypeScript interfaces\n- Provider factory pattern\n- Migration strategy from current Morph-only code","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-02T23:49:31.555841-08:00","updated_at":"2025-12-02T23:49:31.555841-08:00"}
{"id":"cmux15-3os","title":"Document git provider abstraction","description":"Create developer documentation for the git provider abstraction.\n\n## Documentation Needed\n\n### Architecture Overview\n- Provider abstraction pattern explanation\n- How to add a new provider\n- Webhook handling flow\n\n### Setup Guides\n- GitHub App setup (existing, update)\n- GitLab App setup (new)\n- Bitbucket OAuth setup (new)\n\n### API Reference\n- GitProvider interface documentation\n- Normalized types documentation\n- Webhook event mapping table\n\n### Migration Guide\n- How to migrate existing GitHub-only code\n- Breaking changes list\n- Deprecation timeline\n\n## Files to Create (if requested)\n- docs/git-providers/architecture.md\n- docs/git-providers/adding-providers.md\n- docs/git-providers/webhook-events.md\n\n## Code Comments\n- Add JSDoc to all interfaces\n- Document provider-specific quirks\n- Note any missing features per provider","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T22:58:17.343312-08:00","updated_at":"2025-12-02T22:58:17.343312-08:00","dependencies":[{"issue_id":"cmux15-3os","depends_on_id":"cmux15-282","type":"blocks","created_at":"2025-12-02T22:58:22.383628-08:00","created_by":"daemon"}]}
{"id":"cmux15-4o8","title":"Update crown worker for multi-provider PR creation","description":"Update crown worker to create PRs on GitLab and Bitbucket, not just GitHub.\n\n## Current State\napps/worker/src/crown/pullRequest.ts:\n- Uses `gh pr create` CLI command\n- Only handles GitHub PRs\n\napps/worker/src/crown/workflow.ts:\n- Hardcodes `https://github.com/${info.task.projectFullName}.git`\n\n## gh CLI Commands Used\n```bash\ngh pr create --base \"$PR_BASE\" --head \"$PR_HEAD\" --title \"$PR_TITLE\" --body-file \"$BODY_FILE\" --json url,number,state,isDraft\n```\n\n## Provider CLI Equivalents\n| Action | GitHub | GitLab | Bitbucket |\n|--------|--------|--------|-----------|\n| Create PR/MR | gh pr create | glab mr create | API only |\n| Get PR URL | --json url | --json web_url | API response |\n\n## Implementation Options\n\n### Option A: CLI per provider\n```typescript\nfunction createPrWithCli(provider: Provider, params: CreatePRParams) {\n  switch(provider) {\n    case 'github': return execGhPrCreate(params)\n    case 'gitlab': return execGlabMrCreate(params)\n    case 'bitbucket': return createBitbucketPrViaApi(params)\n  }\n}\n```\n\n### Option B: Use API abstraction (preferred)\n- Use the provider abstraction layer from cmux15-7f4\n- More consistent behavior across providers\n- No CLI dependency\n\n## Files to Modify\n- apps/worker/src/crown/pullRequest.ts\n- apps/worker/src/crown/workflow.ts\n\n## Dependencies\n- Requires cmux15-7f4 (PR operations abstraction)\n- Requires cmux15-c6k (URL parsing)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:31:35.715814-08:00","updated_at":"2025-12-02T23:31:35.715814-08:00","dependencies":[{"issue_id":"cmux15-4o8","depends_on_id":"cmux15-7f4","type":"blocks","created_at":"2025-12-02T23:31:40.649353-08:00","created_by":"daemon"},{"issue_id":"cmux15-4o8","depends_on_id":"cmux15-c6k","type":"blocks","created_at":"2025-12-02T23:31:40.69077-08:00","created_by":"daemon"}]}
{"id":"cmux15-5ex","title":"Update VSCodeInstance abstraction for new VM providers","description":"Extend the existing VSCodeInstance abstraction to support new providers.\n\n## Current State\n- apps/server/src/vscode/VSCodeInstance.ts - Abstract base class\n- apps/server/src/vscode/CmuxVSCodeInstance.ts - Morph implementation (uses www API)\n- apps/server/src/vscode/DockerVSCodeInstance.ts - Docker implementation\n\n## VSCodeInstance Interface\n```typescript\ninterface VSCodeInstanceInfo {\n  url: string\n  workspaceUrl: string\n  instanceId: string\n  taskRunId: Id\u003c'taskRuns'\u003e\n  provider: 'docker' | 'morph' | 'daytona'\n}\n\nabstract class VSCodeInstance {\n  abstract start(): Promise\u003cVSCodeInstanceInfo\u003e\n  abstract stop(): Promise\u003cvoid\u003e\n  abstract getStatus(): Promise\u003c{ running: boolean; info?: VSCodeInstanceInfo }\u003e\n}\n```\n\n## New Provider Implementations Needed\n```typescript\n// apps/server/src/vscode/DaytonaVSCodeInstance.ts\nclass DaytonaVSCodeInstance extends VSCodeInstance {\n  // Implement Daytona-specific logic\n}\n```\n\n## Changes Needed\n1. CmuxVSCodeInstance should use provider abstraction (not assume Morph)\n2. Add DaytonaVSCodeInstance\n3. Factory to create correct instance type based on environment/settings\n4. Handle provider-specific URL patterns\n\n## Files to Create\n- apps/server/src/vscode/DaytonaVSCodeInstance.ts\n\n## Files to Modify\n- apps/server/src/vscode/CmuxVSCodeInstance.ts\n- apps/server/src/vscode/VSCodeInstance.ts (if interface changes needed)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:52:59.89349-08:00","updated_at":"2025-12-02T23:52:59.89349-08:00","dependencies":[{"issue_id":"cmux15-5ex","depends_on_id":"cmux15-czo","type":"blocks","created_at":"2025-12-02T23:53:04.747675-08:00","created_by":"daemon"}]}
{"id":"cmux15-6jg","title":"Create core VMProvider interface","description":"Define the core TypeScript interfaces that all VM providers must implement.\n\n## Proposed Interface\n```typescript\n// packages/shared/src/vm-providers/types.ts\n\ntype VMProviderName = 'morph' | 'daytona' | 'fly' | 'railway' | 'docker'\n\ninterface VMProviderConfig {\n  apiKey?: string\n  baseUrl?: string\n  // Provider-specific options\n  [key: string]: unknown\n}\n\ninterface VMInstance {\n  id: string\n  provider: VMProviderName\n  status: 'starting' | 'running' | 'paused' | 'stopped'\n  metadata: Record\u003cstring, string\u003e\n  \n  // Lifecycle\n  start(): Promise\u003cvoid\u003e\n  stop(): Promise\u003cvoid\u003e\n  pause?(): Promise\u003cvoid\u003e\n  resume?(): Promise\u003cvoid\u003e\n  \n  // Command execution\n  exec(command: string): Promise\u003cExecResult\u003e\n  \n  // Networking\n  getHttpServices(): Promise\u003cHttpService[]\u003e\n  exposePort(port: number): Promise\u003cstring\u003e\n  \n  // Optional: wake-on-demand\n  setWakeOn?(http: boolean, tcp: boolean): Promise\u003cvoid\u003e\n}\n\ninterface HttpService {\n  port: number\n  url: string\n  name?: string\n}\n\ninterface ExecResult {\n  exit_code: number\n  stdout: string\n  stderr: string\n}\n\ninterface VMProvider {\n  name: VMProviderName\n  \n  // Instance management\n  startInstance(config: StartInstanceConfig): Promise\u003cVMInstance\u003e\n  getInstance(instanceId: string): Promise\u003cVMInstance | null\u003e\n  listInstances(filter?: InstanceFilter): Promise\u003cVMInstance[]\u003e\n  \n  // Image/Snapshot management (provider-specific naming)\n  listImages(): Promise\u003cVMImage[]\u003e\n  getImage(imageId: string): Promise\u003cVMImage | null\u003e\n}\n\ninterface StartInstanceConfig {\n  imageId: string  // snapshotId for Morph, image for Docker, workspace for Daytona\n  ttlSeconds?: number\n  ttlAction?: 'stop' | 'pause'\n  metadata?: Record\u003cstring, string\u003e\n  resources?: {\n    vcpu?: number\n    memoryMb?: number\n    diskGb?: number\n  }\n}\n\ninterface VMImage {\n  id: string\n  name: string\n  provider: VMProviderName\n  createdAt?: number\n  // Provider-specific metadata\n  metadata?: Record\u003cstring, unknown\u003e\n}\n```\n\n## Files to Create\n- packages/shared/src/vm-providers/types.ts\n- packages/shared/src/vm-providers/index.ts","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:49:47.670975-08:00","updated_at":"2025-12-02T23:49:47.670975-08:00","dependencies":[{"issue_id":"cmux15-6jg","depends_on_id":"cmux15-2vu","type":"blocks","created_at":"2025-12-02T23:49:52.992737-08:00","created_by":"daemon"}]}
{"id":"cmux15-6ma","title":"Update database schema for multi-provider VM support","description":"Update Convex schema to properly support multiple VM providers.\n\n## Current Schema\n\n### environments table\n```typescript\n{\n  morphSnapshotId: string,  // MorphCloud-specific\n  // No provider field\n}\n```\n\n### environmentSnapshotVersions table\n```typescript\n{\n  morphSnapshotId: string,  // MorphCloud-specific\n}\n```\n\n### taskRuns.vscode\n```typescript\n{\n  provider: 'docker' | 'morph' | 'daytona' | 'other',  // Already abstracted\\!\n  containerName?: string,  // Instance ID\n}\n```\n\n## Required Changes\n\n### environments table\n```typescript\n{\n  // Keep for backward compat\n  morphSnapshotId?: string,\n  \n  // New generalized fields\n  vmProvider: 'morph' | 'daytona' | 'docker' | ...,\n  vmImageId: string,  // Provider-specific image/snapshot ID\n}\n```\n\n### environmentSnapshotVersions table\n```typescript\n{\n  // Keep for backward compat\n  morphSnapshotId?: string,\n  \n  // New\n  vmProvider: 'morph' | 'daytona' | ...,\n  vmImageId: string,\n}\n```\n\n### previewConfigs table\n```typescript\n{\n  // May need provider field if previews can run on different providers\n  vmProvider?: 'morph' | 'daytona' | ...,\n}\n```\n\n## Migration Strategy\n1. Add new fields as optional\n2. Write migration to populate from morphSnapshotId\n3. Update queries to use new fields with fallback\n4. Eventually deprecate morphSnapshotId\n\n## Files to Modify\n- packages/convex/convex/schema.ts\n- packages/convex/convex/environments.ts\n- packages/convex/convex/environmentSnapshots.ts","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:52:03.459826-08:00","updated_at":"2025-12-02T23:52:03.459826-08:00","dependencies":[{"issue_id":"cmux15-6ma","depends_on_id":"cmux15-2vu","type":"blocks","created_at":"2025-12-02T23:52:09.802965-08:00","created_by":"daemon"}]}
{"id":"cmux15-7dc","title":"Update preview system for multi-provider support","description":"Update the preview.new system to work with GitLab and Bitbucket.\n\n## Current State\n- preview.new domain serves screenshot preview functionality\n- packages/convex/convex/previewConfigs.ts - Stores repoProvider, repoInstallationId\n- packages/convex/convex/previewRuns.ts - Tracks PR previews\n- Triggered by GitHub webhook on PR events\n- Posts screenshots as PR comments\n\n## Already Provider-Aware\n- previewConfigs table has `repoProvider` field (defaults to 'github')\n- Can store different installationIds per provider\n\n## Updates Needed\n1. **Webhook Integration**\n   - Trigger preview runs from GitLab MR webhooks\n   - Trigger preview runs from Bitbucket PR webhooks\n\n2. **Screenshot Posting**\n   - Post to GitLab MR notes\n   - Post to Bitbucket PR comments\n\n3. **PR Info Extraction**\n   - Extract PR number, base/head SHA from each provider's format\n\n## Files to Modify\n- packages/convex/convex/previewConfigs.ts - Already has provider field\n- packages/convex/convex/previewRuns.ts - Update PR info extraction\n- packages/convex/convex/preview_jobs_worker.ts - Use provider abstraction\n\n## Considerations\n- Diff heatmap (0github.com) is GitHub-only feature\n- May need provider-specific diff viewer alternatives","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:12:56.436861-08:00","updated_at":"2025-12-02T23:12:56.436861-08:00","dependencies":[{"issue_id":"cmux15-7dc","depends_on_id":"cmux15-cyr","type":"blocks","created_at":"2025-12-02T23:13:03.697951-08:00","created_by":"daemon"},{"issue_id":"cmux15-7dc","depends_on_id":"cmux15-jiw","type":"blocks","created_at":"2025-12-02T23:13:03.792308-08:00","created_by":"daemon"}]}
{"id":"cmux15-7f4","title":"Abstract PR operations (create/merge/close) for git providers","description":"Abstract PR lifecycle operations across providers.\n\n## Current State\n- apps/www/lib/routes/github.prs.open.route.ts - Create, merge, close PRs\n- apps/worker/src/crown/pullRequest.ts - Crown winner auto-PR (uses gh CLI)\n- Uses Octokit for GitHub API calls\n- GraphQL for marking PR ready for review\n\n## Operations to Abstract\n```typescript\ninterface PROperationsProvider {\n  // Create\n  createPullRequest(params: CreatePRParams): Promise\u003cPullRequest\u003e\n  \n  // Update state\n  markReadyForReview(repo: string, number: number): Promise\u003cvoid\u003e\n  closePullRequest(repo: string, number: number): Promise\u003cvoid\u003e\n  reopenPullRequest(repo: string, number: number): Promise\u003cvoid\u003e\n  \n  // Merge\n  mergePullRequest(repo: string, number: number, method: MergeMethod): Promise\u003cvoid\u003e\n  \n  // Query\n  getPullRequest(repo: string, number: number): Promise\u003cPullRequest\u003e\n  getPullRequestByBranch(repo: string, branch: string): Promise\u003cPullRequest | null\u003e\n  listPullRequests(repo: string, options?: ListOptions): Promise\u003cPullRequest[]\u003e\n}\n\ntype MergeMethod = 'merge' | 'squash' | 'rebase'\n```\n\n## Provider Differences\n| Feature | GitHub | GitLab | Bitbucket |\n|---------|--------|--------|-----------|\n| Draft PRs | Supported | Supported (WIP MRs) | Not supported |\n| Merge methods | merge/squash/rebase | merge/squash/rebase | merge/squash |\n| Ready for review | GraphQL mutation | Remove WIP prefix | N/A |\n| Auto-merge | Supported | Supported | Limited |\n\n## Files to Modify\n- apps/www/lib/routes/github.prs.open.route.ts → abstract\n- apps/worker/src/crown/pullRequest.ts → use provider abstraction instead of gh CLI\n\n## Considerations\n- Crown worker currently uses gh CLI - need to abstract or ensure CLI exists for other providers\n- GraphQL vs REST for certain operations\n- Draft PR support varies","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:12:38.436281-08:00","updated_at":"2025-12-02T23:12:38.436281-08:00","dependencies":[{"issue_id":"cmux15-7f4","depends_on_id":"cmux15-lv3","type":"blocks","created_at":"2025-12-02T23:12:43.927552-08:00","created_by":"daemon"}]}
{"id":"cmux15-80t","title":"Design git provider abstraction architecture","description":"Define the core interfaces and architecture for abstracting git providers (GitHub, GitLab, Bitbucket).\n\n## Key Decisions\n- Interface design patterns (strategy pattern, factory pattern)\n- Provider configuration structure\n- How to handle provider-specific features that don't exist in all providers\n- Webhook payload normalization strategy\n- Token/auth abstraction approach\n\n## Deliverables\n- Architecture document or code comments\n- Core TypeScript interfaces\n- Provider factory/registry pattern","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-02T22:54:46.891551-08:00","updated_at":"2025-12-02T23:54:56.349647-08:00"}
{"id":"cmux15-81p","title":"Update preview jobs system for multi-provider VMs","description":"Update preview job system to work with multiple VM providers.\n\n## Current State\nPreview jobs use MorphCloud directly:\n- packages/convex/convex/preview_jobs.ts\n- packages/convex/convex/preview_jobs_worker.ts\n- packages/convex/convex/preview_jobs_http.ts\n\n## MorphCloud-Specific Code\n```typescript\n// preview_jobs.ts\nimport { MorphCloudClient } from 'morphcloud'\n\nconst client = new MorphCloudClient({ apiKey })\nconst instance = await client.instances.start({\n  snapshotId,\n  ttlSeconds,\n  ttlAction: 'pause',\n  metadata: { app: 'cmux-preview', ... }\n})\n```\n\n## Required Changes\n1. Use VM provider abstraction instead of direct MorphCloudClient\n2. Get provider from previewConfig or default\n3. Handle provider-specific features (pause vs stop)\n\n## Files to Modify\n- packages/convex/convex/preview_jobs.ts\n- packages/convex/convex/preview_jobs_worker.ts\n- packages/convex/convex/preview_jobs_http.ts\n\n## Considerations\n- Preview jobs run in Convex (can't use Node packages directly)\n- May need HTTP action to call provider APIs\n- Different providers have different startup times","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:52:21.615262-08:00","updated_at":"2025-12-02T23:52:21.615262-08:00","dependencies":[{"issue_id":"cmux15-81p","depends_on_id":"cmux15-czo","type":"blocks","created_at":"2025-12-02T23:52:28.090509-08:00","created_by":"daemon"},{"issue_id":"cmux15-81p","depends_on_id":"cmux15-6ma","type":"blocks","created_at":"2025-12-02T23:52:28.128666-08:00","created_by":"daemon"}]}
{"id":"cmux15-8b1","title":"Abstract server-side API client (ghApi) for git providers","description":"Abstract the direct GitHub API client to support multiple providers.\n\n## Current State\napps/server/src/ghApi.ts - Direct GitHub API wrapper:\n- Hardcodes `https://api.github.com`\n- Uses GitHub-specific Accept header\n- Methods: getUser, getUserRepos, getUserOrgs, getOrgRepos, getRepoBranches\n\n## Provider API Endpoints\n| Provider | Base URL | Auth Header |\n|----------|----------|-------------|\n| GitHub | api.github.com | Bearer token |\n| GitLab | gitlab.com/api/v4 | PRIVATE-TOKEN or Bearer |\n| Bitbucket | api.bitbucket.org/2.0 | Bearer token |\n\n## API Mapping\n| Feature | GitHub | GitLab | Bitbucket |\n|---------|--------|--------|-----------|\n| Current user | /user | /user | /user |\n| User repos | /user/repos | /projects?membership=true | /repositories |\n| User orgs | /user/orgs | /groups | /workspaces |\n| Org repos | /orgs/:org/repos | /groups/:id/projects | /repositories/:workspace |\n| Branches | /repos/:repo/branches | /projects/:id/repository/branches | /repositories/:repo/refs/branches |\n\n## Implementation\n```typescript\n// apps/server/src/providerApi.ts\ninterface ProviderApiClient {\n  getUser(): Promise\u003c{ login: string }\u003e\n  getUserRepos(): Promise\u003cstring[]\u003e\n  getUserOrgs(): Promise\u003cstring[]\u003e\n  getOrgRepos(org: string): Promise\u003cstring[]\u003e\n  getRepoBranches(repo: string): Promise\u003cstring[]\u003e\n  getRepoBranchesWithActivity(repo: string): Promise\u003cBranchWithActivity[]\u003e\n}\n\nfunction createProviderApiClient(provider: Provider, token: string): ProviderApiClient\n```\n\n## Files to Modify\n- apps/server/src/ghApi.ts → rename to providerApi.ts\n- All files importing ghApi\n\n## Considerations\n- Different pagination styles (GitHub: Link header, GitLab: X-Page headers, Bitbucket: next URL)\n- Different rate limit handling","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:31:59.018826-08:00","updated_at":"2025-12-02T23:31:59.018826-08:00","dependencies":[{"issue_id":"cmux15-8b1","depends_on_id":"cmux15-fy2","type":"blocks","created_at":"2025-12-02T23:32:05.751212-08:00","created_by":"daemon"},{"issue_id":"cmux15-8b1","depends_on_id":"cmux15-t6p","type":"blocks","created_at":"2025-12-02T23:32:05.79401-08:00","created_by":"daemon"}]}
{"id":"cmux15-ab7","title":"Implement GitLab provider adapter","description":"Implement GitLab support using the GitProvider abstraction.\n\n## Files to Create\n- packages/shared/src/git-providers/gitlab/index.ts\n- packages/shared/src/git-providers/gitlab/types.ts\n\n## Implementation\n- Use GitLab REST API v4 or GraphQL API\n- Implement GitProvider interface\n- Map GitLab concepts to normalized types:\n  - Merge Request → PullRequest\n  - Project → Repository\n  - Notes → Comments\n\n## GitLab-Specific Considerations\n- GitLab Apps vs OAuth Apps vs Personal Access Tokens\n- Project access tokens\n- Group-level access\n- Self-hosted GitLab support (custom base URL)\n- MR approval rules (GitLab-specific feature)\n\n## Dependencies\n- @gitbeaker/rest or custom fetch-based client\n- GitLab webhook types","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T22:55:25.425309-08:00","updated_at":"2025-12-02T22:55:25.425309-08:00","dependencies":[{"issue_id":"cmux15-ab7","depends_on_id":"cmux15-t6p","type":"blocks","created_at":"2025-12-02T22:55:40.153419-08:00","created_by":"daemon"}]}
{"id":"cmux15-abu","title":"Add integration tests for VM providers","description":"Create comprehensive tests for the VM provider abstraction.\n\n## Test Categories\n\n### Unit Tests\n- Provider interface implementation tests\n- Instance lifecycle tests (start, stop, pause, resume)\n- Networking/URL generation tests\n\n### Integration Tests\n- MorphCloud provider tests (with API mocks)\n- Daytona provider tests\n- Cross-provider consistency tests\n\n### E2E Tests\n- Sandbox start/stop flow\n- Environment with different providers\n- Preview jobs with different providers\n\n## Test Files to Create\n- packages/shared/src/vm-providers/__tests__/morph.test.ts\n- packages/shared/src/vm-providers/__tests__/daytona.test.ts\n- packages/shared/src/vm-providers/__tests__/registry.test.ts\n- apps/www/lib/routes/__tests__/sandboxes.test.ts\n\n## Test Data\n- Mock provider responses\n- Test fixtures for different providers\n- Sample snapshot/image configurations\n\n## Considerations\n- Use vitest per project conventions\n- Test provider-specific features\n- Test fallback/error handling","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:54:12.711038-08:00","updated_at":"2025-12-02T23:54:12.711038-08:00","dependencies":[{"issue_id":"cmux15-abu","depends_on_id":"cmux15-0bz","type":"blocks","created_at":"2025-12-02T23:54:18.350573-08:00","created_by":"daemon"}]}
{"id":"cmux15-b2c","title":"Update UI for multi-provider support","description":"Update frontend components to support multiple git providers.\n\n## Components to Update\n\n### Provider Selection\n- Add provider selector in integration setup flow\n- Show provider icons (GitHub, GitLab, Bitbucket)\n- Update repository selection to show provider context\n\n### Repository Display\n- Show provider badge/icon next to repo names\n- Update repo URL formatting for different providers\n\n### PR/MR Display\n- Normalize 'Pull Request' vs 'Merge Request' terminology\n- Show provider-appropriate icons and links\n\n### Settings Pages\n- Add GitLab connection UI\n- Add Bitbucket connection UI\n- Show connected providers list\n\n## Files to Modify\n- apps/client/src/components/integrations/* \n- apps/client/src/components/repo-selector/*\n- apps/client/src/routes/settings/*\n\n## New Components\n- ProviderIcon - Display provider logo\n- ProviderBadge - Small badge showing provider\n- ProviderSelector - Dropdown/tabs for provider selection","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T22:57:45.888327-08:00","updated_at":"2025-12-02T22:57:45.888327-08:00","dependencies":[{"issue_id":"cmux15-b2c","depends_on_id":"cmux15-d8u","type":"blocks","created_at":"2025-12-02T22:57:52.621031-08:00","created_by":"daemon"},{"issue_id":"cmux15-b2c","depends_on_id":"cmux15-d3i","type":"blocks","created_at":"2025-12-02T22:57:52.66606-08:00","created_by":"daemon"},{"issue_id":"cmux15-b2c","depends_on_id":"cmux15-2i4","type":"blocks","created_at":"2025-12-02T22:57:52.718468-08:00","created_by":"daemon"}]}
{"id":"cmux15-c6k","title":"Abstract repo URL parsing for git providers","description":"Replace GitHub-specific URL parsing with multi-provider support.\n\n## Current State\n- packages/shared/src/utils/parse-github-repo-url.ts - Only parses GitHub URLs\n- Hardcoded patterns: `github.com`, `git@github.com:`\n\n## Provider URL Formats\n| Provider | HTTPS | SSH |\n|----------|-------|-----|\n| GitHub | https://github.com/owner/repo | git@github.com:owner/repo.git |\n| GitLab | https://gitlab.com/owner/repo | git@gitlab.com:owner/repo.git |\n| Bitbucket | https://bitbucket.org/owner/repo | git@bitbucket.org:owner/repo.git |\n\n## Implementation\n```typescript\n// packages/shared/src/utils/parse-repo-url.ts\ntype Provider = 'github' | 'gitlab' | 'bitbucket' | 'unknown'\n\ninterface ParsedRepoUrl {\n  provider: Provider\n  owner: string\n  repo: string\n  fullName: string\n  url: string\n  gitUrl: string\n}\n\nfunction parseRepoUrl(input: string): ParsedRepoUrl | null\nfunction detectProvider(url: string): Provider\nfunction buildRepoUrl(provider: Provider, owner: string, repo: string): string\n```\n\n## Files to Modify\n- packages/shared/src/utils/parse-github-repo-url.ts → rename to parse-repo-url.ts\n- All files importing parseGithubRepoUrl\n\n## Usages to Update\n- apps/worker/src/screenshotCollector/claudeScreenshotCollectorCli.ts\n- packages/convex/convex/*.ts (multiple files)\n- apps/server/src/socket-handlers.ts","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:29:52.743824-08:00","updated_at":"2025-12-02T23:29:52.743824-08:00","dependencies":[{"issue_id":"cmux15-c6k","depends_on_id":"cmux15-80t","type":"blocks","created_at":"2025-12-02T23:29:58.603415-08:00","created_by":"daemon"}]}
{"id":"cmux15-cyr","title":"Abstract webhook handling for git providers","description":"Create unified webhook handling that normalizes events across providers.\n\n## Current State\n- GitHub webhook handler in packages/convex/convex/github_webhook.ts\n- Handles: installation, pull_request, push, workflow_run, check_run, deployment, status, ping\n\n## Webhook Event Mapping\n\n| Normalized Event | GitHub | GitLab | Bitbucket |\n|-----------------|--------|--------|-----------|\n| pr.opened | pull_request.opened | merge_request.open | pullrequest:created |\n| pr.closed | pull_request.closed | merge_request.close | pullrequest:rejected/declined |\n| pr.merged | pull_request.closed+merged | merge_request.merge | pullrequest:fulfilled |\n| pr.updated | pull_request.synchronize | merge_request.update | pullrequest:updated |\n| push | push | push | repo:push |\n| comment | issue_comment | note | pullrequest:comment_* |\n\n## Implementation\n\n### Webhook Router\n```typescript\n// packages/convex/convex/webhook.ts (new unified handler)\nasync function handleWebhook(provider: string, headers: Headers, body: string) {\n  const providerAdapter = getProviderWebhookAdapter(provider)\n  const verified = await providerAdapter.verifySignature(headers, body)\n  const normalizedEvent = providerAdapter.normalizeEvent(JSON.parse(body))\n  // Route to appropriate handler\n}\n```\n\n### Files to Create\n- packages/convex/convex/webhook.ts - Unified entry point\n- packages/convex/convex/webhook_adapters/github.ts\n- packages/convex/convex/webhook_adapters/gitlab.ts\n- packages/convex/convex/webhook_adapters/bitbucket.ts\n\n### Files to Modify\n- packages/convex/convex/github_webhook.ts → Extract to adapter pattern\n- packages/convex/convex/http.ts → Add routes for /webhook/gitlab, /webhook/bitbucket","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T22:56:08.600244-08:00","updated_at":"2025-12-02T22:56:08.600244-08:00","dependencies":[{"issue_id":"cmux15-cyr","depends_on_id":"cmux15-t6p","type":"blocks","created_at":"2025-12-02T22:56:13.808374-08:00","created_by":"daemon"},{"issue_id":"cmux15-cyr","depends_on_id":"cmux15-u5n","type":"blocks","created_at":"2025-12-02T22:56:13.861146-08:00","created_by":"daemon"}]}
{"id":"cmux15-czo","title":"Abstract sandbox routes to use VM provider interface","description":"Refactor sandbox routes to use the VM provider abstraction instead of direct MorphCloudClient.\n\n## Current State\napps/www/lib/routes/sandboxes.route.ts:\n- Line 12: `import { MorphCloudClient } from 'morphcloud'`\n- Line 221: `const client = new MorphCloudClient({ apiKey: env.MORPH_API_KEY })`\n- Directly calls `client.instances.start()`, `instance.exec()`, etc.\n\napps/www/lib/routes/morph.route.ts:\n- MorphCloud-specific resume/pause endpoints\n- Should be generalized to work with any provider\n\n## Routes to Refactor\n\n### /sandboxes/start\n```typescript\n// Before\nconst client = new MorphCloudClient({ apiKey: env.MORPH_API_KEY })\nconst instance = await client.instances.start({...})\n\n// After\nconst provider = vmProviderRegistry.get(body.provider || 'morph')\nconst instance = await provider.startInstance({...})\n```\n\n### /sandboxes/{id}/stop\n### /sandboxes/{id}/status\n### /sandboxes/{id}/env\n\n### /morph/task-runs/{id}/resume → /sandboxes/{id}/resume\n### /morph/task-runs/{id}/is-paused → /sandboxes/{id}/status\n\n## New Route Structure\n```\nPOST /sandboxes/start\n  body: { provider?: 'morph' | 'daytona', ... }\n\nPOST /sandboxes/{id}/stop\nPOST /sandboxes/{id}/pause (if supported by provider)\nPOST /sandboxes/{id}/resume (if supported by provider)\nGET  /sandboxes/{id}/status\nPOST /sandboxes/{id}/env\nPOST /sandboxes/{id}/exec\n```\n\n## Files to Modify\n- apps/www/lib/routes/sandboxes.route.ts\n- apps/www/lib/routes/morph.route.ts → merge into sandboxes.route.ts\n- apps/www/lib/routes/sandboxes/*.ts (helpers)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:51:17.942606-08:00","updated_at":"2025-12-02T23:51:17.942606-08:00","dependencies":[{"issue_id":"cmux15-czo","depends_on_id":"cmux15-0bz","type":"blocks","created_at":"2025-12-02T23:51:23.19886-08:00","created_by":"daemon"}]}
{"id":"cmux15-d3i","title":"Add GitLab App setup and OAuth flow","description":"Create GitLab App and implement OAuth integration.\n\n## GitLab App Setup\n1. Create GitLab Application at gitlab.com/oauth/applications\n2. Configure scopes: api, read_user, read_repository\n3. Set callback URL to /auth/callback/gitlab\n\n## Implementation\n\n### OAuth Routes\n- GET /auth/gitlab/authorize - Redirect to GitLab OAuth\n- GET /auth/callback/gitlab - Handle OAuth callback\n\n### Stack Auth Integration\n- Add GitLab as OAuth provider in Stack Auth config\n- Store GitLab OAuth tokens\n\n### Environment Variables\n```\nCMUX_GITLAB_APP_ID=\nCMUX_GITLAB_APP_SECRET=\nGITLAB_WEBHOOK_SECRET=\n```\n\n### Files to Create\n- apps/www/lib/routes/gitlab.oauth.route.ts\n- apps/www/lib/routes/gitlab.setup.route.ts\n\n### Considerations\n- GitLab Groups vs Projects access\n- Self-hosted GitLab support (custom baseUrl)\n- GitLab Premium/Ultimate features","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T22:57:15.971669-08:00","updated_at":"2025-12-02T22:57:15.971669-08:00","dependencies":[{"issue_id":"cmux15-d3i","depends_on_id":"cmux15-ab7","type":"blocks","created_at":"2025-12-02T22:57:21.401026-08:00","created_by":"daemon"}]}
{"id":"cmux15-d8u","title":"Abstract Hono API routes for git providers","description":"Refactor API routes to support multiple providers through abstraction.\n\n## Current GitHub-Specific Routes\nAll in apps/www/lib/routes/github.*.route.ts:\n- github.oauth-token.route.ts\n- github.prs.route.ts (list, open, patch, files, file-contents, etc.)\n- github.repos.route.ts\n- github.install-state.route.ts\n\n## Abstraction Strategy\n\n### Option A: Provider Parameter in Existing Routes\n```typescript\n// /integrations/:provider/prs\n// /integrations/:provider/repos\n// Provider extracted from path parameter\n```\n\n### Option B: Unified Routes with Query Param\n```typescript\n// /integrations/prs?provider=github\n// /integrations/repos?provider=gitlab\n```\n\n### Recommended: Option A with Shared Logic\n```typescript\n// apps/www/lib/routes/integrations/\n//   prs.route.ts        (handles all providers)\n//   repos.route.ts\n//   oauth.route.ts\n//   webhooks.route.ts\n\n// Route handler\napp.get('/integrations/:provider/prs', async (c) =\u003e {\n  const provider = c.req.param('provider')\n  const gitProvider = getGitProvider(provider)\n  return gitProvider.listPullRequests(...)\n})\n```\n\n## Files to Create\n- apps/www/lib/routes/integrations/prs.route.ts\n- apps/www/lib/routes/integrations/repos.route.ts\n- apps/www/lib/routes/integrations/oauth.route.ts\n\n## Files to Deprecate/Migrate\n- apps/www/lib/routes/github.*.route.ts → redirect to new routes\n\n## Backward Compatibility\n- Keep old /integrations/github/* routes working\n- Add deprecation warnings in logs","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T22:56:42.93431-08:00","updated_at":"2025-12-02T22:56:42.93431-08:00","dependencies":[{"issue_id":"cmux15-d8u","depends_on_id":"cmux15-saz","type":"blocks","created_at":"2025-12-02T22:56:47.893684-08:00","created_by":"daemon"},{"issue_id":"cmux15-d8u","depends_on_id":"cmux15-u5n","type":"blocks","created_at":"2025-12-02T22:56:47.945075-08:00","created_by":"daemon"}]}
{"id":"cmux15-dcg","title":"Update server socket handlers for multi-provider URLs","description":"Update socket handlers that hardcode GitHub URLs to use provider abstraction.\n\n## Current State\napps/server/src/socket-handlers.ts has multiple hardcoded GitHub URLs:\n- Line 824: `https://github.com/${projectFullName}.git`\n- Line 1980: `targetRepoUrl: https://github.com/${repoFullName}.git`\n- Line 2170: `repoUrl: https://github.com/manaflow-ai/cmux.git`\n\nOther files:\n- apps/server/src/utils/refreshGitHubData.ts: `https://github.com/${repo}.git`\n- apps/server/src/utils/ensureRunWorktree.ts: `https://github.com/${task.projectFullName}.git`\n- apps/server/native/core/src/repo/cache.rs: `https://github.com/{}.git`\n\n## Implementation\n- Import URL builder from provider abstraction\n- Get provider from task/environment context\n- Build correct clone URL based on provider\n\n```typescript\n// Before\nconst repoUrl = `https://github.com/${fullName}.git`\n\n// After\nconst repoUrl = buildCloneUrl(provider, fullName)\n// or\nconst repoUrl = getProviderHelper(provider).buildCloneUrl(fullName)\n```\n\n## Files to Modify\n- apps/server/src/socket-handlers.ts\n- apps/server/src/utils/refreshGitHubData.ts\n- apps/server/src/utils/ensureRunWorktree.ts\n- apps/server/native/core/src/repo/cache.rs (Rust)\n\n## Considerations\n- Provider should come from task.provider or environment.provider\n- Need to handle cases where provider is not set (default to GitHub for backward compat)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:31:17.074131-08:00","updated_at":"2025-12-02T23:31:17.074131-08:00","dependencies":[{"issue_id":"cmux15-dcg","depends_on_id":"cmux15-c6k","type":"blocks","created_at":"2025-12-02T23:31:22.679867-08:00","created_by":"daemon"},{"issue_id":"cmux15-dcg","depends_on_id":"cmux15-idf","type":"blocks","created_at":"2025-12-02T23:31:22.73036-08:00","created_by":"daemon"}]}
{"id":"cmux15-ddx","title":"Document VM provider abstraction","description":"Create developer documentation for the VM provider abstraction.\n\n## Documentation Needed\n\n### Architecture Overview\n- VM provider abstraction pattern\n- How to add a new provider\n- Instance lifecycle management\n- Networking model\n\n### Provider Setup Guides\n- MorphCloud setup (existing, update)\n- Daytona setup (new)\n- Future: Fly.io, Railway, etc.\n\n### API Reference\n- VMProvider interface documentation\n- VMInstance interface documentation\n- Networking/URL helpers\n\n### Migration Guide\n- How to migrate existing Morph-only code\n- Environment configuration changes\n- Breaking changes list\n\n## Code Comments\n- Add JSDoc to all interfaces\n- Document provider-specific quirks\n- Note feature availability per provider","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:54:27.100592-08:00","updated_at":"2025-12-02T23:54:27.100592-08:00","dependencies":[{"issue_id":"cmux15-ddx","depends_on_id":"cmux15-abu","type":"blocks","created_at":"2025-12-02T23:54:31.750411-08:00","created_by":"daemon"}]}
{"id":"cmux15-dvj","title":"Implement MorphCloud provider adapter","description":"Refactor existing MorphCloud code into the VMProvider abstraction.\n\n## Current MorphCloud Integration Points\n- packages/morphcloud-openapi-client/ - Generated API client\n- apps/www/lib/routes/sandboxes.route.ts - Direct MorphCloudClient usage\n- apps/www/lib/routes/morph.route.ts - Resume/pause endpoints\n- packages/convex/convex/preview_jobs.ts - Instance management\n- packages/convex/convex/preview_jobs_worker.ts - Background operations\n- packages/shared/src/morph-snapshots.ts - Snapshot manifest\n\n## MorphCloud-Specific Features\n- Snapshots with versioning (12 versions per preset)\n- Wake-on-demand (`setWakeOn`)\n- Pause/resume (vs full stop)\n- TTL with pause action\n- HTTP service discovery on fixed ports\n- Instance metadata tagging\n\n## Implementation\n```typescript\n// packages/shared/src/vm-providers/morph/index.ts\n\nclass MorphCloudProvider implements VMProvider {\n  name = 'morph' as const\n  private client: MorphCloudClient\n  \n  constructor(config: { apiKey: string }) {\n    this.client = new MorphCloudClient({ apiKey: config.apiKey })\n  }\n  \n  async startInstance(config: StartInstanceConfig): Promise\u003cMorphInstance\u003e {\n    const instance = await this.client.instances.start({\n      snapshotId: config.imageId,\n      ttlSeconds: config.ttlSeconds,\n      ttlAction: config.ttlAction,\n      metadata: config.metadata,\n    })\n    return new MorphInstance(instance)\n  }\n  \n  // ... implement other methods\n}\n\nclass MorphInstance implements VMInstance {\n  // Wrap MorphCloud instance with VMInstance interface\n}\n```\n\n## Files to Create\n- packages/shared/src/vm-providers/morph/index.ts\n- packages/shared/src/vm-providers/morph/instance.ts\n- packages/shared/src/vm-providers/morph/snapshots.ts\n\n## Files to Modify\n- apps/www/lib/routes/sandboxes.route.ts → use provider abstraction\n- apps/www/lib/routes/morph.route.ts → use provider abstraction","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:50:08.599284-08:00","updated_at":"2025-12-02T23:50:08.599284-08:00","dependencies":[{"issue_id":"cmux15-dvj","depends_on_id":"cmux15-6jg","type":"blocks","created_at":"2025-12-02T23:50:17.557633-08:00","created_by":"daemon"}]}
{"id":"cmux15-fq3","title":"Implement Daytona provider adapter","description":"Implement Daytona support using the VMProvider abstraction.\n\n## Daytona Overview\n- Open-source development environment manager\n- Workspace-based model (vs snapshot-based)\n- Docker-based or cloud-based execution\n- Built-in IDE support\n\n## Current State\n- Schema already includes 'daytona' provider option\n- Some scripts exist: scripts/daytona-worker.ts, scripts/daytona-snapshot.ts\n\n## Daytona Concepts Mapping\n| cmux Concept | Daytona Equivalent |\n|--------------|-------------------|\n| Snapshot/Image | Workspace template / Project |\n| Instance | Workspace |\n| Start | daytona create |\n| Stop | daytona delete |\n| Pause | daytona stop |\n| Resume | daytona start |\n| Exec | daytona ssh + command |\n\n## Implementation\n```typescript\n// packages/shared/src/vm-providers/daytona/index.ts\n\nclass DaytonaProvider implements VMProvider {\n  name = 'daytona' as const\n  \n  async startInstance(config: StartInstanceConfig): Promise\u003cDaytonaInstance\u003e {\n    // Use Daytona SDK/CLI to create workspace\n    // Map imageId to workspace template\n  }\n}\n```\n\n## Files to Create\n- packages/shared/src/vm-providers/daytona/index.ts\n- packages/shared/src/vm-providers/daytona/instance.ts\n\n## Dependencies\n- Daytona SDK or CLI wrapper\n- Daytona server configuration","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:50:37.49847-08:00","updated_at":"2025-12-02T23:50:37.49847-08:00","dependencies":[{"issue_id":"cmux15-fq3","depends_on_id":"cmux15-6jg","type":"blocks","created_at":"2025-12-02T23:50:45.904961-08:00","created_by":"daemon"}]}
{"id":"cmux15-fy2","title":"Abstract token retrieval for git providers","description":"Abstract OAuth token retrieval to support multiple providers.\n\n## Current State\nFiles with GitHub-specific token retrieval:\n- apps/server/src/utils/getGitHubToken.ts - Gets GitHub OAuth token from Stack Auth or gh CLI\n- apps/www/lib/routes/github.oauth-token.route.ts - Returns GitHub OAuth token\n\n## Token Sources\n| Source | GitHub | GitLab | Bitbucket |\n|--------|--------|--------|-----------|\n| Stack Auth | getConnectedAccount('github') | getConnectedAccount('gitlab') | getConnectedAccount('bitbucket') |\n| CLI | gh auth token | glab auth token | N/A (no official CLI) |\n| Env var | GITHUB_TOKEN | GITLAB_TOKEN | BITBUCKET_TOKEN |\n\n## Implementation\n```typescript\n// apps/server/src/utils/getProviderToken.ts\ntype Provider = 'github' | 'gitlab' | 'bitbucket'\n\nasync function getProviderToken(provider: Provider): Promise\u003cstring | null\u003e\nasync function getProviderTokenFromStackAuth(provider: Provider): Promise\u003cstring | null\u003e\nasync function getProviderTokenFromCli(provider: Provider): Promise\u003cstring | null\u003e\n```\n\n## Files to Modify\n- apps/server/src/utils/getGitHubToken.ts → rename to getProviderToken.ts\n- apps/www/lib/routes/github.oauth-token.route.ts → abstract to provider route\n\n## CLI Considerations\n- GitHub: `gh auth token` (widely available)\n- GitLab: `glab auth token` (less common)\n- Bitbucket: No official CLI, may need to skip or use env var","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:30:11.071188-08:00","updated_at":"2025-12-02T23:30:11.071188-08:00","dependencies":[{"issue_id":"cmux15-fy2","depends_on_id":"cmux15-u5n","type":"blocks","created_at":"2025-12-02T23:30:18.569684-08:00","created_by":"daemon"}]}
{"id":"cmux15-gcu","title":"Abstract URL generation and networking for VM providers","description":"Abstract URL generation and service discovery across providers.\n\n## Current State\nMorphCloud-specific URL handling:\n- packages/shared/src/utils/morph-instance.ts - Parse morph.so URLs\n- apps/client/src/lib/toProxyWorkspaceUrl.ts - Transform to cmux.app proxy\n- apps/edge-router/src/index.ts - Route based on morph hostnames\n\n## URL Patterns\n| Provider | Instance URL Pattern |\n|----------|---------------------|\n| MorphCloud | https://{port}-{instanceId}.http.cloud.morph.so |\n| Daytona | https://{workspace}.{server}/... |\n| Docker | http://localhost:{port} |\n\n## cmux Proxy URLs\nCurrently transforms:\n- morph.so URLs → cmux.app proxy URLs\n\nNeed to support:\n- Multiple provider URL patterns\n- Different authentication methods per provider\n- Port/service mapping\n\n## Abstraction\n```typescript\ninterface VMNetworking {\n  // Get URL for a specific port/service\n  getServiceUrl(instance: VMInstance, port: number): string\n  \n  // Get VSCode URL\n  getVSCodeUrl(instance: VMInstance): string\n  \n  // Get worker URL\n  getWorkerUrl(instance: VMInstance): string\n  \n  // Transform to proxy URL (if applicable)\n  toProxyUrl(providerUrl: string): string\n  \n  // Parse provider URL to extract instance info\n  parseProviderUrl(url: string): { provider: string; instanceId: string; port?: number } | null\n}\n```\n\n## Files to Modify\n- packages/shared/src/utils/morph-instance.ts → generalize\n- apps/client/src/lib/toProxyWorkspaceUrl.ts\n- apps/edge-router/src/index.ts (may need provider-aware routing)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:53:17.775065-08:00","updated_at":"2025-12-02T23:53:17.775065-08:00","dependencies":[{"issue_id":"cmux15-gcu","depends_on_id":"cmux15-6jg","type":"blocks","created_at":"2025-12-02T23:53:22.844746-08:00","created_by":"daemon"}]}
{"id":"cmux15-idf","title":"Abstract git credentials setup in containers/sandboxes","description":"Abstract git credential setup to support multiple providers in Docker containers and sandboxes.\n\n## Current State (GitHub-only)\nFiles with hardcoded github.com credentials:\n- apps/server/src/utils/dockerGitSetup.ts - Writes `https://oauth:${token}@github.com`\n- apps/server/src/vscode/DockerVSCodeInstance.ts - Uses `gh auth login`\n- apps/worker/src/index.ts - Writes github.com git credentials\n- packages/convex/convex/preview_jobs_worker.ts - Uses `gh auth login`\n- packages/sandbox/src/*.rs - Caches `gh auth status`\n\n## Provider CLI Tools\n| Provider | CLI | Auth Command |\n|----------|-----|--------------|\n| GitHub | gh | gh auth login --with-token |\n| GitLab | glab | glab auth login --token |\n| Bitbucket | N/A | git config credential.helper |\n\n## Git Credentials Format\n```\n# Multi-provider git-credentials file\nhttps://oauth:${githubToken}@github.com\nhttps://oauth:${gitlabToken}@gitlab.com\nhttps://x-token-auth:${bitbucketToken}@bitbucket.org\n```\n\n## Implementation\n```typescript\ninterface GitCredential {\n  provider: Provider\n  host: string\n  username: string\n  token: string\n}\n\nfunction buildGitCredentialsFile(credentials: GitCredential[]): string\nfunction setupProviderCliAuth(provider: Provider, token: string): Promise\u003cvoid\u003e\n```\n\n## Files to Modify\n- apps/server/src/utils/dockerGitSetup.ts\n- apps/server/src/vscode/DockerVSCodeInstance.ts\n- apps/worker/src/index.ts\n- packages/convex/convex/preview_jobs_worker.ts\n\n## Sandbox (Rust) Changes\n- packages/sandbox/src/service.rs - Cache per-provider auth status\n- packages/sandbox/src/bin/server.rs - Handle provider-specific CLI checks","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:30:37.399675-08:00","updated_at":"2025-12-02T23:30:37.399675-08:00","dependencies":[{"issue_id":"cmux15-idf","depends_on_id":"cmux15-fy2","type":"blocks","created_at":"2025-12-02T23:30:43.891927-08:00","created_by":"daemon"},{"issue_id":"cmux15-idf","depends_on_id":"cmux15-c6k","type":"blocks","created_at":"2025-12-02T23:30:43.932851-08:00","created_by":"daemon"}]}
{"id":"cmux15-jiw","title":"Abstract PR comments posting for git providers","description":"Abstract the PR comment posting functionality used by preview screenshots.\n\n## Current State\n- packages/convex/convex/github_pr_comments.ts - Posts screenshot previews as PR comments\n- Uses Octokit directly for GitHub API\n- Creates/updates/collapses comments on PRs\n- Includes 0github.com diff heatmap links (GitHub-specific)\n\n## Provider Differences\n| Feature | GitHub | GitLab | Bitbucket |\n|---------|--------|--------|-----------|\n| PR Comments | Issue comments API | MR Notes API | PR Comments API |\n| Reactions | Reactions API | Award Emoji API | Not supported |\n| Collapse old | HTML details tag | Same | Same |\n| Diff view URL | 0github.com (custom) | GitLab native diff | Bitbucket native diff |\n\n## Implementation\n```typescript\ninterface PRCommentsProvider {\n  createComment(repo: string, prNumber: number, body: string): Promise\u003cCommentResult\u003e\n  updateComment(repo: string, commentId: number, body: string): Promise\u003cCommentResult\u003e\n  listComments(repo: string, prNumber: number): Promise\u003cComment[]\u003e\n  addReaction?(repo: string, prNumber: number, reaction: string): Promise\u003cvoid\u003e\n}\n```\n\n## Files to Modify\n- packages/convex/convex/github_pr_comments.ts → abstract\n\n## Considerations\n- 0github.com is GitHub-specific (diff heatmap viewer)\n- Need provider-specific diff URLs or skip for non-GitHub\n- Reaction support varies by provider","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:12:18.085123-08:00","updated_at":"2025-12-02T23:12:18.085123-08:00","dependencies":[{"issue_id":"cmux15-jiw","depends_on_id":"cmux15-lv3","type":"blocks","created_at":"2025-12-02T23:12:24.11438-08:00","created_by":"daemon"}]}
{"id":"cmux15-k3z","title":"Abstract screenshot collector CLI for git providers","description":"Update screenshot collector to work with GitLab MRs and Bitbucket PRs.\n\n## Current State\n- apps/worker/src/screenshotCollector/claudeScreenshotCollectorCli.ts\n- Uses `gh pr view` to get PR info\n- Parses only github.com URLs\n- Clones from github.com\n\n## gh CLI Commands Used\n```bash\ngh pr view ${prNumber} --repo ${owner}/${repo} --json baseRefName,headRefName,title,body\ngh pr view ${prNumber} --repo ${owner}/${repo} --json files --jq '.files[].path'\ngh pr view ${prNumber} --repo ${owner}/${repo} --json headRefName --jq '.headRefName'\n```\n\n## Provider CLI Equivalents\n| Action | GitHub | GitLab | Bitbucket |\n|--------|--------|--------|-----------|\n| View MR/PR | gh pr view | glab mr view | API call |\n| Get files | gh pr view --json files | glab mr view --json | API call |\n| Get branch | gh pr view --json headRefName | glab mr view -F json | API call |\n\n## Implementation Options\n\n### Option A: Abstract CLI wrapper\n```typescript\ninterface ProviderCli {\n  getPRInfo(repo: string, number: number): Promise\u003cPRInfo\u003e\n  getPRFiles(repo: string, number: number): Promise\u003cstring[]\u003e\n  getPRBranch(repo: string, number: number): Promise\u003cstring\u003e\n}\n```\n\n### Option B: Use API instead of CLI\n- More reliable and consistent across providers\n- Already have provider abstraction layer\n\n## Files to Modify\n- apps/worker/src/screenshotCollector/claudeScreenshotCollectorCli.ts\n- Should use provider abstraction instead of raw CLI calls","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:30:56.793333-08:00","updated_at":"2025-12-02T23:30:56.793333-08:00","dependencies":[{"issue_id":"cmux15-k3z","depends_on_id":"cmux15-7dc","type":"blocks","created_at":"2025-12-02T23:31:02.381494-08:00","created_by":"daemon"},{"issue_id":"cmux15-k3z","depends_on_id":"cmux15-c6k","type":"blocks","created_at":"2025-12-02T23:31:02.422859-08:00","created_by":"daemon"}]}
{"id":"cmux15-l9s","title":"Abstract workspace hydration for VM providers","description":"Abstract the workspace setup/hydration process across providers.\n\n## Current State\nHydration happens via MorphCloud instance.exec():\n- apps/www/lib/routes/sandboxes/hydration.ts - Repo cloning\n- apps/www/lib/routes/sandboxes/git.ts - Git/GitHub config\n- apps/www/lib/routes/sandboxes/startDevAndMaintenanceScript.ts - Script execution\n\n## Hydration Steps\n1. Clone repository\n2. Configure git identity (user.name, user.email)\n3. Configure git credentials (GitHub token)\n4. Apply environment variables (envctl)\n5. Run maintenance script\n6. Run dev script\n\n## Provider Differences\n| Step | MorphCloud | Daytona | Docker |\n|------|-----------|---------|--------|\n| Clone | instance.exec(`git clone`) | Built-in (workspace from git) | docker exec |\n| Git config | instance.exec(`git config`) | Built-in | docker exec |\n| Env vars | envctl via exec | Built-in env support | docker -e |\n| Scripts | instance.exec(script) | daytona exec | docker exec |\n\n## Abstraction\n```typescript\ninterface WorkspaceHydrator {\n  // Clone repository into workspace\n  cloneRepository(instance: VMInstance, config: CloneConfig): Promise\u003cvoid\u003e\n  \n  // Configure git identity\n  configureGitIdentity(instance: VMInstance, identity: GitIdentity): Promise\u003cvoid\u003e\n  \n  // Configure git credentials\n  configureGitCredentials(instance: VMInstance, token: string): Promise\u003cvoid\u003e\n  \n  // Apply environment variables\n  applyEnvVars(instance: VMInstance, envVars: string): Promise\u003cvoid\u003e\n  \n  // Run scripts\n  runScript(instance: VMInstance, script: string, options?: ScriptOptions): Promise\u003cvoid\u003e\n}\n```\n\n## Files to Modify\n- apps/www/lib/routes/sandboxes/hydration.ts\n- apps/www/lib/routes/sandboxes/git.ts\n- apps/www/lib/routes/sandboxes/startDevAndMaintenanceScript.ts","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:52:42.672863-08:00","updated_at":"2025-12-02T23:52:42.672863-08:00","dependencies":[{"issue_id":"cmux15-l9s","depends_on_id":"cmux15-0bz","type":"blocks","created_at":"2025-12-02T23:52:47.832636-08:00","created_by":"daemon"}]}
{"id":"cmux15-lv3","title":"Create provider factory and registry","description":"Implement factory pattern for instantiating git providers.\n\n## Implementation\n\n### Provider Registry\n```typescript\n// packages/shared/src/git-providers/registry.ts\n\ntype ProviderName = 'github' | 'gitlab' | 'bitbucket'\n\nconst providers: Record\u003cProviderName, () =\u003e GitProvider\u003e = {\n  github: () =\u003e new GitHubProvider(config.github),\n  gitlab: () =\u003e new GitLabProvider(config.gitlab),\n  bitbucket: () =\u003e new BitbucketProvider(config.bitbucket),\n}\n\nexport function getProvider(name: ProviderName): GitProvider {\n  const factory = providers[name]\n  if (\\!factory) throw new Error(`Unknown provider: ${name}`)\n  return factory()\n}\n\nexport function getProviderForInstallation(installationId: string): Promise\u003cGitProvider\u003e {\n  // Look up provider from providerConnections table\n}\n```\n\n### Configuration\n```typescript\n// packages/shared/src/git-providers/config.ts\n\ninterface ProviderConfig {\n  github?: {\n    appId: string\n    privateKey: string\n    webhookSecret: string\n  }\n  gitlab?: {\n    appId: string\n    appSecret: string\n    webhookSecret: string\n    baseUrl?: string  // For self-hosted\n  }\n  bitbucket?: {\n    appKey: string\n    appSecret: string\n    webhookSecret: string\n  }\n}\n```\n\n## Usage Examples\n```typescript\n// In route handlers\nconst provider = getProvider(req.params.provider)\nconst prs = await provider.listPullRequests(repo)\n\n// In webhook handlers\nconst provider = getProviderForInstallation(installationId)\nawait provider.addReaction(repo, prNumber, 'eyes')\n```\n\n## Files to Create\n- packages/shared/src/git-providers/registry.ts\n- packages/shared/src/git-providers/config.ts","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T22:56:59.411446-08:00","updated_at":"2025-12-02T22:56:59.411446-08:00","dependencies":[{"issue_id":"cmux15-lv3","depends_on_id":"cmux15-saz","type":"blocks","created_at":"2025-12-02T22:57:06.47341-08:00","created_by":"daemon"},{"issue_id":"cmux15-lv3","depends_on_id":"cmux15-ab7","type":"blocks","created_at":"2025-12-02T22:57:06.51816-08:00","created_by":"daemon"},{"issue_id":"cmux15-lv3","depends_on_id":"cmux15-08d","type":"blocks","created_at":"2025-12-02T22:57:06.566599-08:00","created_by":"daemon"}]}
{"id":"cmux15-oxp","title":"Update database schema for multi-provider support","description":"Modify Convex schema to support multiple git providers.\n\n## Current GitHub-Specific Tables\n- providerConnections - Already has 'provider' field, good!\n- pullRequests - Has 'provider' field\n- githubWorkflowRuns - GitHub-specific (Actions)\n- githubCheckRuns - GitHub-specific (Checks API)\n- githubDeployments - GitHub-specific (Deployments API)\n- githubCommitStatuses - GitHub-specific (Status API)\n\n## Schema Changes Needed\n\n### 1. Rename/Generalize Tables\n```typescript\n// Option A: Keep GitHub-specific tables, add parallel tables\n// - gitlabPipelines (equivalent to githubWorkflowRuns)\n// - gitlabJobs (equivalent to githubCheckRuns)\n// - bitbucketPipelines\n\n// Option B: Create generic tables with provider field\n// - ciRuns (unified CI/CD runs)\n// - deployments (unified deployments)\n```\n\n### 2. providerConnections Updates\n- Already supports provider field\n- Need to add GitLab/Bitbucket specific fields\n- Consider: workspace_id (Bitbucket), group_id (GitLab)\n\n### 3. New Indexes\n- Add compound indexes on (provider, installationId)\n- Add indexes for provider-specific queries\n\n### 4. Migration Strategy\n- Keep existing tables working (backward compat)\n- Add new fields as optional initially\n- Gradual migration of queries\n\n## Files to Modify\n- packages/convex/convex/schema.ts","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T22:56:25.820748-08:00","updated_at":"2025-12-02T22:56:25.820748-08:00","dependencies":[{"issue_id":"cmux15-oxp","depends_on_id":"cmux15-80t","type":"blocks","created_at":"2025-12-02T22:56:30.467005-08:00","created_by":"daemon"}]}
{"id":"cmux15-ppy","title":"Update VM management scripts for multi-provider support","description":"Update maintenance and management scripts to work with multiple providers.\n\n## Current Morph-Only Scripts\n```\nscripts/morph-start-instance.ts\nscripts/morph-snapshot.ts\nscripts/morph-test-snapshot.ts\nscripts/morph-pause-old-active-instances.ts\nscripts/morph-pause-old-sandboxes.ts\nscripts/morph-clean-old-instances.ts\nscripts/morph-kill-excess-10cpu.ts\nscripts/morph-stop-all-instances.ts\nscripts/morph-instance-manager.ts\n```\n\n## Python Scripts\n```\nscripts/morph_snapshot.py\nscripts/morph_start_instance.py\nscripts/morph_boot.py\nscripts/morph_branch.py\nscripts/morph_common.py\n```\n\n## Required Changes\n1. **Instance Management**\n   - Scripts should accept provider as argument\n   - Use provider abstraction for operations\n   - Handle provider-specific cleanup (pause vs stop)\n\n2. **Snapshot/Image Management**\n   - Provider-specific image listing\n   - Cross-provider image info comparison\n\n3. **Monitoring/Cleanup**\n   - Query instances across all providers\n   - Provider-aware resource limits\n\n## Example Refactor\n```typescript\n// Before: morph-pause-old-instances.ts\nconst client = new MorphCloudClient({ apiKey })\nconst instances = await client.instances.list()\n\n// After: pause-old-instances.ts\nconst providers = ['morph', 'daytona'] // or from config\nfor (const providerName of providers) {\n  const provider = vmProviderRegistry.get(providerName)\n  const instances = await provider.listInstances()\n  // ... cleanup logic\n}\n```\n\n## Files to Modify (or generalize)\n- scripts/morph-*.ts → scripts/vm-*.ts\n- Update to use provider abstraction","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:53:58.433826-08:00","updated_at":"2025-12-02T23:53:58.433826-08:00","dependencies":[{"issue_id":"cmux15-ppy","depends_on_id":"cmux15-0bz","type":"blocks","created_at":"2025-12-02T23:54:03.148628-08:00","created_by":"daemon"}]}
{"id":"cmux15-saz","title":"Implement GitHub provider adapter","description":"Refactor existing GitHub code into the new provider abstraction.\n\n## Files to Modify\n- packages/convex/_shared/githubApp.ts → Extract to provider pattern\n- apps/www/lib/utils/github-app-token.ts → Use provider abstraction\n- apps/www/lib/github/*.ts → Migrate to provider\n\n## Implementation\n- Create packages/shared/src/git-providers/github/index.ts\n- Implement GitProvider interface using existing Octokit code\n- Keep backward compatibility during migration\n- Map GitHub-specific responses to normalized types\n\n## Considerations\n- GitHub App authentication flow\n- Installation tokens\n- GitHub-specific features (Actions, Checks, Deployments)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T22:55:15.125579-08:00","updated_at":"2025-12-02T22:55:15.125579-08:00","dependencies":[{"issue_id":"cmux15-saz","depends_on_id":"cmux15-t6p","type":"blocks","created_at":"2025-12-02T22:55:40.101323-08:00","created_by":"daemon"}]}
{"id":"cmux15-slv","title":"Update UI for multi-provider VM support","description":"Update frontend to support selecting and displaying multiple VM providers.\n\n## Current State\n- Provider selection may be implicit (always Morph)\n- Environment configuration has morphSnapshotId\n- Instance status shows Morph-specific info\n\n## UI Components to Update\n\n### Environment Configuration\n- apps/client/src/components/EnvironmentConfiguration.tsx\n- apps/client/src/routes/_layout.$teamSlugOrId.environments.new.tsx\n- Need to add provider selector (Morph, Daytona, etc.)\n- Show provider-specific options (snapshots vs templates)\n\n### Dashboard\n- apps/client/src/routes/_layout.$teamSlugOrId.dashboard.tsx\n- Show provider badge on running instances\n- Handle provider-specific status (paused vs stopped)\n\n### Instance Controls\n- apps/client/src/hooks/useMorphWorkspace.ts → generalize to useVMWorkspace\n- Pause/resume controls (provider-specific availability)\n\n### Preview Configuration\n- apps/www/components/preview/preview-configure-client.tsx\n- May need provider selection for preview environments\n\n## New Components\n- ProviderSelector - Dropdown to select VM provider\n- ProviderBadge - Show provider icon/name\n- ProviderCapabilities - Show what features are available\n\n## Files to Modify\n- apps/client/src/hooks/useMorphWorkspace.ts → rename/generalize\n- apps/client/src/components/EnvironmentConfiguration.tsx\n- apps/client/src/types/environment.ts","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:53:35.473859-08:00","updated_at":"2025-12-02T23:53:35.473859-08:00","dependencies":[{"issue_id":"cmux15-slv","depends_on_id":"cmux15-czo","type":"blocks","created_at":"2025-12-02T23:53:41.364854-08:00","created_by":"daemon"},{"issue_id":"cmux15-slv","depends_on_id":"cmux15-6ma","type":"blocks","created_at":"2025-12-02T23:53:41.405307-08:00","created_by":"daemon"}]}
{"id":"cmux15-t6p","title":"Create core GitProvider interface","description":"Implement the core TypeScript interfaces that all git providers must implement.\n\n## Files to Create/Modify\n- packages/shared/src/git-providers/types.ts - Core interfaces\n- packages/shared/src/git-providers/index.ts - Exports\n\n## Interfaces Needed\n```typescript\ninterface GitProvider {\n  name: 'github' | 'gitlab' | 'bitbucket'\n  // Authentication\n  createAppAuth(): Promise\u003cAuthResult\u003e\n  getInstallationToken(installationId: string): Promise\u003cstring\u003e\n  // Repositories\n  listRepositories(installationId: string): AsyncIterable\u003cRepository\u003e\n  getRepository(owner: string, repo: string): Promise\u003cRepository\u003e\n  // Pull Requests / Merge Requests\n  listPullRequests(repo: string, options?: PRListOptions): Promise\u003cPullRequest[]\u003e\n  getPullRequest(repo: string, number: number): Promise\u003cPullRequest\u003e\n  createPullRequest(repo: string, params: CreatePRParams): Promise\u003cPullRequest\u003e\n  getPullRequestPatch(repo: string, number: number): Promise\u003cstring\u003e\n  getPullRequestFiles(repo: string, number: number): Promise\u003cPRFile[]\u003e\n  // Comments\n  createPRComment(repo: string, number: number, body: string): Promise\u003cComment\u003e\n  updatePRComment(repo: string, commentId: number, body: string): Promise\u003cComment\u003e\n  // Reactions\n  addReaction(repo: string, issueNumber: number, reaction: string): Promise\u003cvoid\u003e\n  // File Contents\n  getFileContent(repo: string, path: string, ref?: string): Promise\u003cstring\u003e\n}\n```\n\n## Normalized Types\n- Repository, PullRequest, Branch, User, Comment, etc.\n- Map provider-specific fields to common fields","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T22:54:57.750531-08:00","updated_at":"2025-12-02T22:54:57.750531-08:00","dependencies":[{"issue_id":"cmux15-t6p","depends_on_id":"cmux15-80t","type":"blocks","created_at":"2025-12-02T22:55:05.415868-08:00","created_by":"daemon"}]}
{"id":"cmux15-tcf","title":"Abstract CI/CD status tracking for git providers","description":"Abstract CI/CD pipeline status tracking across providers.\n\n## Current State (GitHub-specific tables)\n- githubWorkflowRuns - GitHub Actions workflow runs\n- githubCheckRuns - Third-party checks (Vercel, etc.)\n- githubDeployments - Deployment events\n- githubCommitStatuses - Legacy commit status API\n\n## Provider CI/CD Systems\n| Feature | GitHub | GitLab | Bitbucket |\n|---------|--------|--------|-----------|\n| CI/CD | Actions | Pipelines | Pipelines |\n| Checks | Check Runs API | Pipeline jobs | Build status |\n| Deployments | Environments | Environments | Deployments |\n| Status API | Commit status | Commit status | Build status |\n\n## Options\n\n### Option A: Unified Tables\n```typescript\n// ciRuns - unified CI/CD runs\n{\n  provider: 'github' | 'gitlab' | 'bitbucket'\n  runId: string  // provider-specific ID\n  pipelineId?: string\n  name: string\n  status: 'queued' | 'in_progress' | 'completed'\n  conclusion?: 'success' | 'failure' | 'cancelled' | ...\n  // ...normalized fields\n}\n```\n\n### Option B: Provider-Specific Tables (current approach extended)\n- Keep githubWorkflowRuns\n- Add gitlabPipelines, gitlabJobs\n- Add bitbucketPipelines\n\n## Webhook Events\n| Event | GitHub | GitLab | Bitbucket |\n|-------|--------|--------|-----------|\n| CI start | workflow_run.queued | pipeline.pending | repo:commit_status_created |\n| CI complete | workflow_run.completed | pipeline.success/failed | repo:commit_status_updated |\n| Check | check_run | pipeline job | build status |\n\n## Considerations\n- Different granularity (workflow vs job vs step)\n- Not all fields map cleanly\n- May want to query 'all CI status for this commit' across providers","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:13:20.554037-08:00","updated_at":"2025-12-02T23:13:20.554037-08:00","dependencies":[{"issue_id":"cmux15-tcf","depends_on_id":"cmux15-cyr","type":"blocks","created_at":"2025-12-02T23:13:27.662206-08:00","created_by":"daemon"},{"issue_id":"cmux15-tcf","depends_on_id":"cmux15-oxp","type":"blocks","created_at":"2025-12-02T23:13:27.713223-08:00","created_by":"daemon"}]}
{"id":"cmux15-u5n","title":"Abstract authentication layer for git providers","description":"Create unified authentication handling for all git providers.\n\n## Current State (GitHub-only)\n- GitHub App with JWT + installation tokens\n- OAuth tokens via Stack Auth\n- Environment: CMUX_GITHUB_APP_ID, CMUX_GITHUB_APP_PRIVATE_KEY\n\n## Required Abstraction\n\n### Environment Variables Pattern\n```\n# GitHub\nCMUX_GITHUB_APP_ID\nCMUX_GITHUB_APP_PRIVATE_KEY\nGITHUB_APP_WEBHOOK_SECRET\n\n# GitLab\nCMUX_GITLAB_APP_ID\nCMUX_GITLAB_APP_SECRET\nGITLAB_WEBHOOK_SECRET\n\n# Bitbucket\nCMUX_BITBUCKET_APP_KEY\nCMUX_BITBUCKET_APP_SECRET\nBITBUCKET_WEBHOOK_SECRET\n```\n\n### Auth Interface\n```typescript\ninterface ProviderAuth {\n  getAppToken(): Promise\u003cstring\u003e\n  getInstallationToken(installationId: string, permissions?: Permissions): Promise\u003cTokenResult\u003e\n  validateWebhookSignature(payload: string, signature: string): boolean\n  getOAuthUrl(state: string, scopes: string[]): string\n  exchangeOAuthCode(code: string): Promise\u003cOAuthTokens\u003e\n}\n```\n\n## Files to Modify\n- packages/convex/_shared/convex-env.ts - Add new env vars\n- packages/convex/_shared/githubApp.ts → refactor to provider pattern\n- apps/www/lib/utils/github-app-token.ts → abstract","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T22:55:51.909751-08:00","updated_at":"2025-12-02T22:55:51.909751-08:00","dependencies":[{"issue_id":"cmux15-u5n","depends_on_id":"cmux15-t6p","type":"blocks","created_at":"2025-12-02T22:55:56.379716-08:00","created_by":"daemon"}]}
{"id":"cmux15-xha","title":"Abstract file content retrieval for git providers","description":"Abstract file content retrieval across providers for code review and diff viewing.\n\n## Current State\n- apps/www/lib/routes/github.prs.file-contents.route.ts - Get file at specific ref\n- apps/www/lib/routes/github.prs.file-contents-batch.route.ts - Batch file retrieval\n- apps/www/lib/routes/github.prs.patch.route.ts - Get PR patch/diff\n- apps/www/lib/routes/github.prs.files.route.ts - List changed files\n\n## Operations to Abstract\n```typescript\ninterface FileContentsProvider {\n  // Single file\n  getFileContent(repo: string, path: string, ref?: string): Promise\u003cFileContent\u003e\n  \n  // Batch files\n  getFileContentsBatch(repo: string, files: FileRequest[]): Promise\u003cFileContent[]\u003e\n  \n  // PR-specific\n  getPRPatch(repo: string, prNumber: number): Promise\u003cstring\u003e\n  getPRChangedFiles(repo: string, prNumber: number): Promise\u003cChangedFile[]\u003e\n  \n  // Compare\n  getCompare(repo: string, base: string, head: string): Promise\u003cCompareResult\u003e\n}\n\ninterface FileContent {\n  path: string\n  content: string\n  encoding: 'utf-8' | 'base64'\n  sha?: string\n  size?: number\n}\n\ninterface ChangedFile {\n  filename: string\n  status: 'added' | 'removed' | 'modified' | 'renamed'\n  additions: number\n  deletions: number\n  patch?: string\n}\n```\n\n## Provider Differences\n| Feature | GitHub | GitLab | Bitbucket |\n|---------|--------|--------|-----------|\n| File content | contents API | repository files API | src endpoint |\n| Batch files | GraphQL | GraphQL | Multiple requests |\n| PR diff | pulls.get (diff media type) | MR changes | diffstat endpoint |\n| Compare | repos.compareCommits | compare | diff endpoint |\n\n## Files to Modify\n- apps/www/lib/routes/github.prs.file-contents*.route.ts\n- apps/www/lib/routes/github.prs.patch.route.ts\n- apps/www/lib/routes/github.prs.files.route.ts","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T23:13:41.487378-08:00","updated_at":"2025-12-02T23:13:41.487378-08:00","dependencies":[{"issue_id":"cmux15-xha","depends_on_id":"cmux15-lv3","type":"blocks","created_at":"2025-12-02T23:13:46.205114-08:00","created_by":"daemon"}]}
