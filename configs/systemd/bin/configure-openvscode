#!/usr/bin/env bash
set -euo pipefail

mkdir -p /var/log/cmux

color=""
case "${VSCODE_THEME:-}" in
  dark)
    color="Default Dark Modern"
    ;;
  light)
    color="Default Light Modern"
    ;;
  system)
    color="Default Dark Modern"
    ;;
esac

# Default settings that are essential for container functionality
DEFAULT_SETTINGS=$(jq -n \
  --arg theme "$color" \
  '{
    "workbench.startupEditor": "none",
    "terminal.integrated.shellIntegration.enabled": false,
    "terminal.integrated.macOptionClickForcesSelection": true,
    "terminal.integrated.shell.linux": "/usr/bin/zsh",
    "terminal.integrated.shellArgs.linux": ["-l"],
    "terminal.integrated.defaultProfile.linux": "zsh",
    "terminal.integrated.profiles.linux": {
      "zsh": {
        "path": "/usr/bin/zsh",
        "args": ["-l"]
      }
    },
    "python.languageServer": "Pylance",
    "python.defaultInterpreterPath": "/usr/bin/python3",
    "git.openDiffOnClick": true,
    "scm.defaultViewMode": "tree",
    "git.showPushSuccessNotification": true,
    "git.autorefresh": true,
    "git.branchCompareWith": "main"
  } + (if $theme != "" then {"workbench.colorTheme": $theme} else {} end)')

home="${HOME:-/root}"
user_base="${home}/.openvscode-server"
user_dir="${user_base}/data/User"
default_profile_dir="${user_base}/data/User/profiles/default-profile"
machine_dir="${user_base}/data/Machine"
user_settings_mount="${home}/.openvscode-server/user-settings"

mkdir -p "${user_dir}" "${default_profile_dir}" "${machine_dir}"

# Check if user settings were mounted from host
if [ -f "${user_settings_mount}/settings.json" ]; then
  echo "Found user VSCode settings, merging with defaults..."

  # Merge user settings with default settings (defaults take precedence)
  USER_SETTINGS=$(cat "${user_settings_mount}/settings.json")
  MERGED_SETTINGS=$(echo "$USER_SETTINGS" "$DEFAULT_SETTINGS" | jq -s '.[0] * .[1]')

  printf '%s' "$MERGED_SETTINGS" > "${user_dir}/settings.json"
  printf '%s' "$MERGED_SETTINGS" > "${default_profile_dir}/settings.json"
  printf '%s' "$MERGED_SETTINGS" > "${machine_dir}/settings.json"

  # Copy keybindings if present
  if [ -f "${user_settings_mount}/keybindings.json" ]; then
    echo "Copying user keybindings..."
    cp "${user_settings_mount}/keybindings.json" "${user_dir}/keybindings.json"
    cp "${user_settings_mount}/keybindings.json" "${default_profile_dir}/keybindings.json"
  fi

  # Copy snippets if present
  if [ -d "${user_settings_mount}/snippets" ]; then
    echo "Copying user snippets..."
    mkdir -p "${user_dir}/snippets"
    mkdir -p "${default_profile_dir}/snippets"
    cp -r "${user_settings_mount}/snippets/"* "${user_dir}/snippets/" 2>/dev/null || true
    cp -r "${user_settings_mount}/snippets/"* "${default_profile_dir}/snippets/" 2>/dev/null || true
  fi

  echo "User VSCode settings applied successfully"
else
  echo "No user VSCode settings found, using defaults..."
  printf '%s' "$DEFAULT_SETTINGS" > "${user_dir}/settings.json"
  printf '%s' "$DEFAULT_SETTINGS" > "${default_profile_dir}/settings.json"
  printf '%s' "$DEFAULT_SETTINGS" > "${machine_dir}/settings.json"
fi
