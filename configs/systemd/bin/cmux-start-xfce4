#!/usr/bin/env bash
# Start XFCE4 desktop session with proper dbus setup
set -euo pipefail

export DISPLAY="${DISPLAY:-:1}"
export HOME="/root"
export XDG_RUNTIME_DIR="/run/user/0"
export XDG_CONFIG_HOME="/root/.config"
export XDG_DATA_HOME="/root/.local/share"
export XDG_CACHE_HOME="/root/.cache"

# Ensure runtime directory exists
mkdir -p "${XDG_RUNTIME_DIR}"
chmod 700 "${XDG_RUNTIME_DIR}"

# Create config directories
mkdir -p "${XDG_CONFIG_HOME}/xfce4/xfconf/xfce-perchannel-xml"
mkdir -p "${XDG_DATA_HOME}"
mkdir -p "${XDG_CACHE_HOME}"

# Start dbus session if not already running
if [ -z "${DBUS_SESSION_BUS_ADDRESS:-}" ]; then
  if [ -S "${XDG_RUNTIME_DIR}/bus" ]; then
    export DBUS_SESSION_BUS_ADDRESS="unix:path=${XDG_RUNTIME_DIR}/bus"
  else
    eval "$(dbus-launch --sh-syntax)"
  fi
fi

# Configure XFCE4 panel and desktop settings for a clean look
cat > "${XDG_CONFIG_HOME}/xfce4/xfconf/xfce-perchannel-xml/xfce4-desktop.xml" << 'XFCE_DESKTOP'
<?xml version="1.0" encoding="UTF-8"?>
<channel name="xfce4-desktop" version="1.0">
  <property name="backdrop" type="empty">
    <property name="screen0" type="empty">
      <property name="monitorVNC-0" type="empty">
        <property name="workspace0" type="empty">
          <property name="color-style" type="int" value="0"/>
          <property name="image-style" type="int" value="0"/>
          <property name="rgba1" type="array">
            <value type="double" value="0.121569"/>
            <value type="double" value="0.121569"/>
            <value type="double" value="0.156863"/>
            <value type="double" value="1"/>
          </property>
        </property>
      </property>
      <property name="monitor0" type="empty">
        <property name="workspace0" type="empty">
          <property name="color-style" type="int" value="0"/>
          <property name="image-style" type="int" value="0"/>
          <property name="rgba1" type="array">
            <value type="double" value="0.121569"/>
            <value type="double" value="0.121569"/>
            <value type="double" value="0.156863"/>
            <value type="double" value="1"/>
          </property>
        </property>
      </property>
    </property>
  </property>
  <property name="desktop-icons" type="empty">
    <property name="style" type="int" value="2"/>
    <property name="file-icons" type="empty">
      <property name="show-home" type="bool" value="true"/>
      <property name="show-filesystem" type="bool" value="false"/>
      <property name="show-trash" type="bool" value="true"/>
      <property name="show-removable" type="bool" value="false"/>
    </property>
  </property>
</channel>
XFCE_DESKTOP

# Configure window manager for modern look
cat > "${XDG_CONFIG_HOME}/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml" << 'XFWM4'
<?xml version="1.0" encoding="UTF-8"?>
<channel name="xfwm4" version="1.0">
  <property name="general" type="empty">
    <property name="theme" type="string" value="Default"/>
    <property name="title_font" type="string" value="Sans Bold 9"/>
    <property name="use_compositing" type="bool" value="false"/>
    <property name="placement_ratio" type="int" value="20"/>
    <property name="show_frame_shadow" type="bool" value="false"/>
  </property>
</channel>
XFWM4

# Configure panel to be at the bottom
cat > "${XDG_CONFIG_HOME}/xfce4/xfconf/xfce-perchannel-xml/xfce4-panel.xml" << 'PANEL'
<?xml version="1.0" encoding="UTF-8"?>
<channel name="xfce4-panel" version="1.0">
  <property name="configver" type="int" value="2"/>
  <property name="panels" type="array">
    <value type="int" value="1"/>
    <property name="dark-mode" type="bool" value="true"/>
    <property name="panel-1" type="empty">
      <property name="position" type="string" value="p=8;x=960;y=1054"/>
      <property name="length" type="uint" value="100"/>
      <property name="position-locked" type="bool" value="true"/>
      <property name="icon-size" type="uint" value="24"/>
      <property name="size" type="uint" value="32"/>
      <property name="plugin-ids" type="array">
        <value type="int" value="1"/>
        <value type="int" value="2"/>
        <value type="int" value="3"/>
        <value type="int" value="4"/>
        <value type="int" value="5"/>
        <value type="int" value="6"/>
      </property>
    </property>
  </property>
  <property name="plugins" type="empty">
    <property name="plugin-1" type="string" value="applicationsmenu">
      <property name="show-button-title" type="bool" value="false"/>
    </property>
    <property name="plugin-2" type="string" value="tasklist">
      <property name="flat-buttons" type="bool" value="true"/>
      <property name="show-handle" type="bool" value="false"/>
    </property>
    <property name="plugin-3" type="string" value="separator">
      <property name="expand" type="bool" value="true"/>
      <property name="style" type="uint" value="0"/>
    </property>
    <property name="plugin-4" type="string" value="systray">
      <property name="square-icons" type="bool" value="true"/>
    </property>
    <property name="plugin-5" type="string" value="clock">
      <property name="digital-format" type="string" value="%R"/>
    </property>
    <property name="plugin-6" type="string" value="actions"/>
  </property>
</channel>
PANEL

exec startxfce4
